project_name       = "ai-pr-reviewer"
environment        = "prod"
log_retention_days = 14

# AWS region (default: us-gov-west-1 for GovCloud)
# aws_region = "us-gov-west-1"

# GitHub Enterprise Server API base URL
# For github.com: https://api.github.com
# For GitHub Enterprise Server: https://<your-ghes-hostname>/api/v3
github_api_base = "https://github.example.com/api/v3"

# Optional explicit allow-list. Empty list means allow all repos where app is installed.
github_allowed_repos = [
  # "my-org/my-repo"
]

# ── Private webhook (GHES over Direct Connect) ──────────────────────────
# Enable this block when your GHES cannot reach the public API Gateway endpoint.
# After apply, run: terraform output webhook_vpce_private_ips
# Open a firewall hole from GHES host to those IPs on port 443, then
# add to GHES /etc/hosts: <private_ip>  <api_id>.execute-api.<region>.amazonaws.com
# Use terraform output webhook_private_url as the GHES webhook URL.
#
# webhook_private_enabled       = true
# webhook_private_vpc_id        = "vpc-xxxxxxxx"           # VPC where DX lands
# webhook_private_subnet_ids    = ["subnet-xxxxxxxx"]      # one subnet = one stable IP
# webhook_private_allowed_cidrs = ["10.x.x.x/32"]         # GHES host IP
# ────────────────────────────────────────────────────────────────────────

# ── Webhook Nginx proxy (GHES, port 443 only, internal CA cert) ──────────
# Use this when port 80 is blocked and you have an internal CA cert GHES trusts.
# Requires webhook_private_enabled=true (VPCE must exist).
#
# Steps:
#   1. Issue cert from internal CA for the proxy EC2 IP/hostname
#   2. Store cert PEM in Secrets Manager -> webhook_proxy_tls_cert_secret_arn
#   3. Store key PEM in Secrets Manager  -> webhook_proxy_tls_key_secret_arn
#   4. terraform apply
#   5. terraform output webhook_proxy_url  -> GHES webhook URL
#   6. terraform output webhook_proxy_private_ip -> open firewall hole on 443
#
# webhook_proxy_enabled                 = true
# webhook_proxy_subnet_id               = "subnet-xxxxxxxx"   # same VPC as VPCE
# webhook_proxy_private_ip              = "10.x.x.x"          # stable fixed IP (recommended)
# webhook_proxy_allowed_cidrs           = ["10.x.x.x/32"]     # GHES host IP
# webhook_proxy_tls_cert_secret_arn     = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789:secret:webhook-proxy-cert"
# webhook_proxy_tls_key_secret_arn      = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789:secret:webhook-proxy-key"
# webhook_proxy_key_name                = ""                   # optional SSH key pair
# ────────────────────────────────────────────────────────────────────────

# Bedrock config
bedrock_agent_id       = ""
bedrock_agent_alias_id = ""
bedrock_model_id       = "anthropic.claude-3-5-sonnet-20241022-v2:0"  # GovCloud FedRAMP/IL4/5 authorized

# 2-stage review: fast model for planner (Stage 1), capable model for reviewer (Stage 2).
# Leave both empty to use bedrock_model_id for both stages (single-stage mode).
# bedrock_model_light = "anthropic.claude-3-haiku-20240307-v1:0"   # Stage 1 — fast triage
# bedrock_model_heavy = "anthropic.claude-3-5-sonnet-20241022-v2:0" # Stage 2 — full review
bedrock_guardrail_id      = ""
bedrock_guardrail_version = ""
bedrock_guardrail_trace   = "DISABLED"

dry_run = true

# Autonomous remediation PR mode (off by default for safety)
auto_pr_enabled       = false
auto_pr_max_files     = 5
auto_pr_branch_prefix = "ai-autofix"
review_comment_mode   = "inline_best_effort"
check_run_name        = "AI PR Reviewer"

# ── PR review tuning knobs ───────────────────────────────────────────────
# P1-B: Incremental review (only new commits since last review)
incremental_review_enabled = true

# P2-A: Diff compression
max_review_files     = 30
max_diff_bytes       = 8000
max_total_diff_bytes = 0       # 0 = max_diff_bytes * max_review_files
large_patch_policy   = "clip"  # clip | skip
# skip_patterns = ""           # comma-separated extra glob patterns to exclude

# P2-B: Ignore / filter knobs
# ignore_pr_authors          = []  # e.g. ["dependabot[bot]", "renovate[bot]"]
# ignore_pr_labels           = []  # e.g. ["skip-review", "wip"]
# ignore_pr_source_branches  = []  # e.g. ["dependabot/*"]
# ignore_pr_target_branches  = []  # e.g. ["main"]
num_max_findings        = 0     # 0 = unlimited
require_security_review = true
require_tests_review    = true

# P3: Structured verdict
failure_on_severity    = "high"  # high | medium | none
review_effort_estimate = false

# Jira/Confluence chatbot service
chatbot_enabled = true
chatbot_model_id = "anthropic.claude-3-5-sonnet-20241022-v2:0"
chatbot_guardrail_id = ""
chatbot_guardrail_version = ""
chatbot_guardrail_trace = "disabled"

# Bedrock Guardrails (Terraform-managed)
create_bedrock_guardrail_resources = false
create_chatbot_guardrail_resources = false

chatbot_retrieval_mode = "hybrid"
chatbot_default_assistant_mode = "contextual"
chatbot_llm_provider = "bedrock"
chatbot_allowed_llm_providers = ["bedrock"]
chatbot_allowed_model_ids = [
  # "amazon.nova-lite-v1:0",
  # "amazon.nova-pro-v1:0",
  # "anthropic.claude-3-7-sonnet-20250219-v1:0",
]
chatbot_github_live_enabled = false
chatbot_github_live_repos = []
chatbot_github_live_max_results = 2
chatbot_memory_enabled = false
chatbot_atlassian_user_auth_enabled = false
chatbot_atlassian_session_broker_enabled = false
chatbot_atlassian_session_ttl_seconds = 3600
chatbot_memory_max_turns = 4
chatbot_memory_ttl_days = 30
chatbot_memory_compaction_chars = 12000
chatbot_user_requests_per_minute = 120
chatbot_conversation_requests_per_minute = 60
chatbot_quota_fail_open = false
chatbot_response_cache_enabled = true
chatbot_response_cache_table = ""
chatbot_response_cache_ttl_seconds = 1200
chatbot_response_cache_min_query_length = 12
chatbot_response_cache_max_answer_chars = 16000
chatbot_response_cache_lock_ttl_seconds = 15
chatbot_response_cache_lock_wait_ms = 150
chatbot_response_cache_lock_wait_attempts = 6
chatbot_rerank_enabled = true
chatbot_rerank_top_k_per_source = 3
chatbot_prompt_safety_enabled = true
chatbot_context_safety_block_request = false
chatbot_safety_scan_char_limit = 8000
chatbot_context_max_chars_per_source = 2500
chatbot_context_max_total_chars = 8000
chatbot_budgets_enabled = true
chatbot_budget_table = ""
chatbot_budget_soft_limit_usd = 0.25
chatbot_budget_hard_limit_usd = 0.75
chatbot_budget_ttl_days = 90
chatbot_jira_max_results = 3
chatbot_confluence_max_results = 3
chatbot_router_low_cost_bedrock_model_id = "amazon.nova-lite-v1:0"
chatbot_router_high_quality_bedrock_model_id = ""
chatbot_model_pricing_json = "{}"
worker_lambda_architecture = "arm64"
worker_lambda_memory_size = 768
chatbot_lambda_architecture = "arm64"
chatbot_lambda_memory_size = 384

# Image generation (NOT AVAILABLE IN GOVCLOUD us-gov-west-1)
# WARNING: Amazon Titan, Nova Canvas, and Stability AI models are NOT in GovCloud
# GovCloud users: Keep chatbot_image_enabled = false or use SageMaker alternative
chatbot_image_model_id = "amazon.nova-canvas-v1:0"  # Not available in GovCloud
chatbot_image_enabled = false  # MUST be false for GovCloud
chatbot_image_default_size = "1024x1024"
chatbot_image_safety_enabled = true
chatbot_image_banned_terms = ["explicit sexual", "nudity", "child sexual", "self-harm", "graphic gore", "extreme violence", "dismemberment"]
chatbot_image_user_requests_per_minute = 6
chatbot_image_conversation_requests_per_minute = 3
chatbot_observability_enabled = true
chatbot_metrics_namespace = ""
chatbot_websocket_enabled = true
chatbot_websocket_stage = "prod"
chatbot_websocket_default_chunk_chars = 120
bedrock_knowledge_base_id = ""
bedrock_kb_top_k = 3

# Optional managed Bedrock KB creation (advanced)
# If true, Terraform can create KB + data source and optionally the backing role/OpenSearch collection.
create_bedrock_kb_resources = false
create_managed_bedrock_kb_role = false
managed_bedrock_kb_role_arn = ""
managed_bedrock_kb_role_name = "bedrock-kb-service-role"
create_managed_bedrock_kb_opensearch_collection = false
managed_bedrock_kb_opensearch_collection_name = "bedrock-kb"
managed_bedrock_kb_opensearch_allow_public = false
managed_bedrock_kb_opensearch_collection_arn = ""
managed_bedrock_kb_opensearch_vector_index_name = "bedrock-kb-default-index"
managed_bedrock_kb_embedding_model_arn = "arn:aws-us-gov:bedrock:us-gov-west-1::foundation-model/amazon.titan-embed-text-v2:0"
managed_bedrock_kb_vector_field = "bedrock-knowledge-base-default-vector"
managed_bedrock_kb_text_field = "AMAZON_BEDROCK_TEXT_CHUNK"
managed_bedrock_kb_metadata_field = "AMAZON_BEDROCK_METADATA"
managed_bedrock_kb_data_source_name = "primary-s3"

# Scheduled Confluence -> Bedrock Knowledge Base sync
kb_sync_enabled = false
bedrock_kb_data_source_id = ""
kb_sync_schedule_expression = "rate(6 hours)"
kb_sync_s3_prefix = "confluence"
confluence_sync_cql = "type=page order by lastmodified desc"
confluence_sync_limit = 25

# Scheduled GitHub docs -> Bedrock Knowledge Base sync
github_kb_sync_enabled = false
github_kb_data_source_id = ""
github_kb_sync_schedule_expression = "rate(6 hours)"
github_kb_sync_s3_prefix = "github"
github_kb_repos = []
github_kb_include_patterns = ["README.md", "docs/**", "**/*.md"]
github_kb_max_files_per_repo = 200

# Teams adapter endpoint
teams_adapter_enabled = false
teams_adapter_token   = ""

# Secrets Manager mode
# Recommended: use existing secrets only (no Terraform secret creation)
create_secrets_manager_secrets = false
existing_github_webhook_secret_arn         = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789012:secret:ai-pr-reviewer/prod/github_webhook_secret"
existing_github_app_private_key_secret_arn = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789012:secret:ai-pr-reviewer/prod/github_app_private_key_pem"
existing_github_app_ids_secret_arn         = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789012:secret:ai-pr-reviewer/prod/github_app_ids"
existing_atlassian_credentials_secret_arn  = "arn:aws-us-gov:secretsmanager:us-gov-west-1:123456789012:secret:ai-pr-reviewer/prod/atlassian_credentials"
existing_chatbot_api_token_secret_arn      = "" # required when chatbot_auth_mode="token"
existing_teams_adapter_token_secret_arn    = "" # required when teams_adapter_enabled=true

# Optional: only used if create_secrets_manager_secrets=true
chatbot_api_token = ""

# Chatbot route login/auth mode:
# - token       => existing X-Api-Token / X-Teams-Adapter-Token checks inside Lambda
# - jwt         => API Gateway JWT authorizer (company SSO/OIDC)
# - github_oauth => API Gateway Lambda authorizer validates GitHub OAuth bearer token
chatbot_auth_mode     = "jwt"
chatbot_jwt_issuer    = "<SET_OIDC_ISSUER>"
chatbot_jwt_audience  = ["<SET_OIDC_AUDIENCE>"]
github_oauth_allowed_orgs = []
# For GitHub OAuth defaults in EC2 web UI, set these when using chatbot_auth_mode="github_oauth"
# chatbot_auth_mode                  = "github_oauth"
# github_oauth_allowed_orgs          = ["my-org"]
# webapp_default_auth_mode           = "bearer"
# webapp_default_github_oauth_base_url = "https://github.my-company.mil"
# webapp_default_github_client_id    = "Iv1.0123456789abcdef"
# webapp_default_github_scope        = "read:user read:org"

# CloudWatch alarms (leave empty to disable alarms)
alarm_sns_topic_arn = ""

# Release notes generator
release_notes_enabled  = false
release_notes_model_id = ""

# Sprint/standup report agent
sprint_report_enabled             = false
sprint_report_model_id            = ""
sprint_report_schedule_enabled    = false
sprint_report_schedule_expression = "cron(0 9 ? * MON-FRI *)"
sprint_report_repo                = ""
sprint_report_jira_project        = ""
sprint_report_jql                 = ""
sprint_report_type                = "standup"
sprint_report_days_back           = 1

# Test generation agent
test_gen_enabled       = false
test_gen_model_id      = ""
test_gen_delivery_mode = "comment"
test_gen_max_files     = 10

# PR description generator
pr_description_enabled  = false
pr_description_model_id = ""

# Optional S3-hosted static chatbot web UI
webapp_hosting_enabled = false
webapp_hosting_mode    = "s3"
webapp_bucket_name     = ""

# Optional fixed-IP static chatbot web UI (ec2_eip mode)
# webapp_hosting_mode         = "ec2_eip"
# webapp_private_only         = true
# webapp_ec2_subnet_id        = "subnet-xxxxxxxx"
# webapp_ec2_instance_type    = "t3.micro"
# webapp_ec2_allowed_cidrs    = ["203.0.113.10/32"]
# webapp_ec2_key_name         = "my-keypair"
# webapp_ec2_ami_id           = "" # optional override
# webapp_ec2_security_group_id = "" # optional: use existing security group instead of creating one
#
# Bring-Your-Own EC2: set instance_id + iam_role_name to skip Terraform-managed EC2 creation.
# webapp_ec2_instance_id      = "i-0abc1234def567890"  # your existing EC2 instance
# webapp_ec2_iam_role_name    = "my-ec2-instance-role" # IAM role name attached to that instance
#
# webapp_tls_enabled          = true
# webapp_tls_acm_certificate_arn = "arn:aws-us-gov:acm:us-gov-west-1:123456789012:certificate/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
# webapp_tls_subnet_ids       = ["subnet-aaaaaaa", "subnet-bbbbbbb"]
# webapp_default_chatbot_url  = "https://<api-id>.execute-api.us-gov-west-1.amazonaws.com/chatbot/query"
