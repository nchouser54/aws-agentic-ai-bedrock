name: Lambda Power Tuning

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: "AWS region"
        required: true
        default: "us-gov-west-1"
      state_machine_arn:
        description: "Lambda Power Tuning Step Functions state machine ARN"
        required: true
      function_name:
        description: "Lambda function name or ARN to tune"
        required: true
      strategy:
        description: "Optimization strategy"
        required: true
        default: "balanced"
        type: choice
        options:
          - cost
          - speed
          - balanced
      num:
        description: "Invocations per memory value"
        required: true
        default: "25"
      power_values:
        description: "Comma-separated memory values (MB)"
        required: true
        default: "128,256,512,768,1024,1536,2048,2560,3008"
      payload_json:
        description: "Optional JSON payload sent to target function"
        required: false
        default: "{}"

jobs:
  tune-lambda:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure AWS credentials (OIDC role)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ inputs.aws_region }}
          role-session-name: lambda-power-tuning

      - name: Configure AWS credentials (access keys fallback)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}

      - name: Validate AWS credential configuration
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' && (secrets.AWS_ACCESS_KEY_ID == '' || secrets.AWS_SECRET_ACCESS_KEY == '') }}
        run: |
          echo "::error::Set AWS_ROLE_TO_ASSUME or AWS_ACCESS_KEY_ID/AWS_SECRET_ACCESS_KEY secrets to run power tuning."
          exit 1

      - name: Run Lambda Power Tuning
        run: |
          python scripts/run_lambda_power_tuning.py \
            --state-machine-arn "${{ inputs.state_machine_arn }}" \
            --function-name "${{ inputs.function_name }}" \
            --region "${{ inputs.aws_region }}" \
            --strategy "${{ inputs.strategy }}" \
            --num "${{ inputs.num }}" \
            --power-values "${{ inputs.power_values }}" \
            --payload-json '${{ inputs.payload_json }}' \
            --output-file lambda-power-tuning-result.json

      - name: Upload tuning result
        uses: actions/upload-artifact@v4
        with:
          name: lambda-power-tuning-result
          path: lambda-power-tuning-result.json
